<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Бронирование</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 1em; }
    input, select, textarea, button { width: 100%; padding: 8px; margin-top: 0.5em; }
    #calendar { margin-top: 1em; }
    .disabled-date { color: #aaa; text-decoration: line-through; }
    #guestForm, #submitButton { display: none; }
  </style>
</head>
<body>
  <h2>Забронируйте номер</h2>

  <label>Выберите номер:
    <select id="roomSelect"></select>
  </label>

  <label>Количество гостей:
    <input type="number" id="guestCount" min="1" />
  </label>

  <label>Дата заезда:
    <input type="date" id="checkIn" />
  </label>

  <label>Дата выезда:
    <input type="date" id="checkOut" />
  </label>

  <div id="calendar"></div>

  <button id="proceedButton" disabled>Перейти к вводу данных</button>

  <div id="guestForm">
    <label>ФИО:
      <input type="text" id="name" />
    </label>
    <label>Телефон:
      <input type="tel" id="phone" placeholder="8-(XXX)-XXX-XX-XX" pattern="8-\(\d{3}\)-\d{3}-\d{2}-\d{2}" />
    </label>
    <label>Email:
      <input type="email" id="email" />
    </label>
    <label>Пожелания:
      <textarea id="wishes"></textarea>
    </label>
    <button id="submitButton">Забронировать</button>
  </div>

  <div id="result"></div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbxeUQLtEHL1Q6XIKnfx2A6_9b3CY-jVrswL2LLLWeNeq6bUKkHmZhYqzN6NYxeQxyusgA/exec';

    let selectedRoom = null;
    let roomData = {};
    let busyDates = [];

    document.addEventListener("DOMContentLoaded", () => {
      fetch(`${apiUrl}?action=getRooms`)
        .then(res => res.json())
        .then(data => {
          const roomSelect = document.getElementById("roomSelect");
          data.forEach(room => {
            roomData[room.room_id] = room;
            const option = document.createElement("option");
            option.value = room.room_id;
            option.textContent = `${room.room_name} — ${room.capacity} гостей — ${room.price}₽/ночь`;
            roomSelect.appendChild(option);
          });
        });

      document.getElementById("roomSelect").addEventListener("change", async (e) => {
        selectedRoom = e.target.value;
        const res = await fetch(`${apiUrl}?action=getBusyDates&room_id=${selectedRoom}`);
        busyDates = await res.json();
        renderCalendar();
      });

      ["checkIn", "checkOut", "guestCount"].forEach(id =>
        document.getElementById(id).addEventListener("change", validateInputs)
      );

      document.getElementById("proceedButton").addEventListener("click", () => {
        document.getElementById("guestForm").style.display = "block";
        document.getElementById("submitButton").style.display = "block";
      });

      document.getElementById("submitButton").addEventListener("click", submitBooking);
    });

    function renderCalendar() {
      const cal = document.getElementById("calendar");
      cal.innerHTML = "<strong>Недоступные даты:</strong><br>" + busyDates.join(', ');
    }

    function validateInputs() {
      const checkIn = document.getElementById("checkIn").value;
      const checkOut = document.getElementById("checkOut").value;
      const guests = +document.getElementById("guestCount").value;
      if (!selectedRoom || !checkIn || !checkOut || guests < 1) return disableProceed();

      const start = new Date(checkIn);
      const end = new Date(checkOut);
      const datesToCheck = [];
      while (start < end) {
        datesToCheck.push(start.toISOString().split('T')[0]);
        start.setDate(start.getDate() + 1);
      }

      const conflict = datesToCheck.some(date => busyDates.includes(date));
      const exceedsCapacity = guests > roomData[selectedRoom].capacity;

      if (!conflict && !exceedsCapacity) {
        document.getElementById("proceedButton").disabled = false;
      } else {
        disableProceed();
      }
    }

    function disableProceed() {
      document.getElementById("proceedButton").disabled = true;
      document.getElementById("guestForm").style.display = "none";
      document.getElementById("submitButton").style.display = "none";
    }

    async function submitBooking() {
      const payload = {
        action: "submitBooking",
        room_id: selectedRoom,
        guests: document.getElementById("guestCount").value,
        checkIn: document.getElementById("checkIn").value,
        checkOut: document.getElementById("checkOut").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        wishes: document.getElementById("wishes").value
      };

      const res = await fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      document.getElementById("result").innerHTML = `<strong>Бронирование успешно!</strong><br>ID: ${result.bookingId}`;
    }
  </script>
</body>
</html>
