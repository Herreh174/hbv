<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Бронирование</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    label, select, input, textarea { display: block; width: 100%; margin-bottom: 10px; }
    button { padding: 10px; }
    .hidden { display: none; }
    .disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <h1>Забронировать номер</h1>

  <label>Выберите номер:</label>
  <select id="roomSelect"></select>

  <label>Количество гостей:</label>
  <input type="number" id="guests" min="1" />

  <label>Дата заезда:</label>
  <input type="date" id="checkin" />

  <label>Дата выезда:</label>
  <input type="date" id="checkout" />

  <button id="nextBtn" class="disabled">Перейти к вводу данных</button>

  <div id="guestForm" class="hidden">
    <label>ФИО:</label>
    <input type="text" id="name" />

    <label>Телефон:</label>
    <input type="tel" id="phone" placeholder="8-(XXX)-XXX-XX-XX" />

    <label>Email:</label>
    <input type="email" id="email" />

    <label>Пожелания по размещению:</label>
    <textarea id="wishes"></textarea>

    <button id="bookBtn" class="disabled">Забронировать</button>
  </div>

  <div id="result" class="hidden"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxeUQLtEHL1Q6XIKnfx2A6_9b3CY-jVrswL2LLLWeNeq6bUKkHmZhYqzN6NYxeQxyusgA/exec';
    let rooms = [];
    let selectedRoom = null;
    let unavailableDates = [];

    async function loadRooms() {
      const res = await fetch(API_URL + '?action=getRooms');
      rooms = await res.json();
      const select = document.getElementById('roomSelect');
      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.room_id;
        option.textContent = `${room.room_name} — ${room.price}₽`;
        select.appendChild(option);
      });
    }

    async function loadUnavailableDates(roomId) {
      const res = await fetch(`${API_URL}?action=getAvailability&room_id=${roomId}`);
      unavailableDates = await res.json();
    }

    function validateDates() {
      const checkin = document.getElementById('checkin').value;
      const checkout = document.getElementById('checkout').value;
      const guests = +document.getElementById('guests').value;
      if (!checkin || !checkout || checkin >= checkout || guests < 1) return false;

      const check = new Date(checkin);
      const out = new Date(checkout);
      for (let d = new Date(check); d < out; d.setDate(d.getDate() + 1)) {
        const formatted = d.toISOString().split('T')[0];
        if (unavailableDates.includes(formatted)) return false;
      }

      const roomCapacity = +rooms.find(r => r.room_id === selectedRoom).capacity;
      return guests <= roomCapacity;
    }

    function enableBookingStep() {
      const valid = validateDates();
      document.getElementById('nextBtn').classList.toggle('disabled', !valid);
    }

    document.getElementById('roomSelect').addEventListener('change', async (e) => {
      selectedRoom = e.target.value;
      await loadUnavailableDates(selectedRoom);
      enableBookingStep();
    });

    ['checkin', 'checkout', 'guests'].forEach(id =>
      document.getElementById(id).addEventListener('input', enableBookingStep)
    );

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!validateDates()) return;
      document.getElementById('guestForm').classList.remove('hidden');
    });

    ['name', 'phone', 'email'].forEach(id =>
      document.getElementById(id).addEventListener('input', () => {
        const filled = ['name', 'phone', 'email'].every(id => document.getElementById(id).value.trim() !== '');
        document.getElementById('bookBtn').classList.toggle('disabled', !filled);
      })
    );

    document.getElementById('bookBtn').addEventListener('click', async () => {
      const room = rooms.find(r => r.room_id === selectedRoom);
      const checkin = document.getElementById('checkin').value;
      const checkout = document.getElementById('checkout').value;
      const guests = +document.getElementById('guests').value;

      const days = (new Date(checkout) - new Date(checkin)) / (1000 * 60 * 60 * 24);
      const total = days * room.price;

      const data = {
        room_id: selectedRoom,
        room_name: room.room_name,
        guests,
        price: room.price,
        checkin,
        checkout,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        wishes: document.getElementById('wishes').value,
        total
      };

      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      });

      const result = await res.json();
      document.getElementById('result').innerHTML = `<h3>Успешно! ID брони: ${result.bookingId}</h3>`;
      document.getElementById('result').classList.remove('hidden');
    });

    loadRooms();
  </script>
</body>
</html>
