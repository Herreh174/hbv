<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Модуль бронирования</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 20px; }
    label { margin-right: 10px; }
    #calendarContainer { display: flex; gap: 20px; margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { width: 30px; height: 30px; text-align: center; border: 1px solid #999; }
    caption { text-align: center; font-weight: bold; margin-bottom: 5px; }
    .busy { background: #faa; }
    .free { background: #afa; cursor: pointer; }
    .selected { background: #66f !important; color: white; }
    #bookingDetails, #customerForm { margin-top: 20px; display: none; }
    #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); }
    #modalContent { background: white; padding: 20px; margin: 100px auto; width: 300px; text-align: center; }
    #closeModal { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Бронирование номера</h1>
  <label for="roomSelect">Выберите номер:</label>
  <select id="roomSelect">
    <option value="">-- Выберите номер --</option>
  </select>

  <div id="calendarContainer">
    <div id="calendar-0"></div>
    <div id="calendar-1"></div>
  </div>

  <div id="bookingDetails">
    <p id="dateRange"></p>
    <label>Кол-во гостей: <input type="number" id="guestsInput" min="1"></label>
    <button id="toForm">Далее</button>
  </div>

  <div id="customerForm">
    <h2>Данные для бронирования</h2>
    <label>ФИО: <input type="text" id="name"></label><br><br>
    <label>Телефон: <input type="tel" id="phone" placeholder="8-(000)-000-00-00"></label><br><br>
    <label>Email: <input type="email" id="email"></label><br><br>
    <label>Пожелания: <textarea id="wishes" rows="3" cols="30"></textarea></label><br><br>
    <button id="submitBooking">Отправить</button>
  </div>

  <div id="modal">
    <div id="modalContent">
      <p id="modalText"></p>
      <button id="closeModal">Закрыть</button>
    </div>
  </div>

  <script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxeUQLtEHL1Q6XIKnfx2A6_9b3CY-jVrswL2LLLWeNeq6bUKkHmZhYqzN6NYxeQxyusgA/exec'; // Замените YOUR_SCRIPT_ID на ваш ID скрипта

  let rooms = [];
  let busyDates = [];
  let selectedRoom = null;
  let selectedStart = null;
  let selectedEnd = null;

  document.addEventListener('DOMContentLoaded', function() {
    loadRooms();
    document.getElementById('roomSelect').addEventListener('change', onRoomChange);
    document.getElementById('toForm').addEventListener('click', showCustomerForm);
    document.getElementById('submitBooking').addEventListener('click', submitBooking);
    document.getElementById('closeModal').addEventListener('click', function() {
      document.getElementById('modal').style.display = 'none';
    });
  });

  function loadRooms() {
    fetch(GAS_URL + '?action=getRooms')
      .then(response => response.json())
      .then(data => {
        rooms = data;
        const select = document.getElementById('roomSelect');
        rooms.forEach(room => {
          const opt = document.createElement('option');
          opt.value = room.id;
          opt.text = room.name + ' (' + room.price + ' руб./ночь, макс ' + room.capacity + ' чел.)';
          select.appendChild(opt);
        });
      })
      .catch(err => alert('Ошибка загрузки списка номеров: ' + err));
  }

  function onRoomChange() {
    const roomId = document.getElementById('roomSelect').value;
    if (!roomId) {
      return;
    }
    selectedRoom = rooms.find(r => r.id === roomId);
    clearSelection();
    fetchCalendar();
  }

  function clearSelection() {
    selectedStart = null;
    selectedEnd = null;
    busyDates = [];
    document.getElementById('bookingDetails').style.display = 'none';
    document.getElementById('customerForm').style.display = 'none';
    document.getElementById('dateRange').innerText = '';
  }

  function fetchCalendar() {
    const today = new Date();
    let year = today.getFullYear();
    let month = today.getMonth() + 1;
    const nextMonth = month === 12 ? 1 : month + 1;
    const nextYear = month === 12 ? year + 1 : year;

    // Текущий месяц
    fetch(GAS_URL + '?action=getCalendar&room_id=' + selectedRoom.id + '&year=' + year + '&month=' + month)
      .then(res => res.json())
      .then(data => {
        busyDates = data;
        drawCalendar('calendar-0', year, month, busyDates);
      })
      .catch(err => console.error(err));

    // Следующий месяц
    fetch(GAS_URL + '?action=getCalendar&room_id=' + selectedRoom.id + '&year=' + nextYear + '&month=' + nextMonth)
      .then(res => res.json())
      .then(data => {
        // Добавляем следующие занятые даты к общему массиву
        busyDates = busyDates.concat(data);
        drawCalendar('calendar-1', nextYear, nextMonth, data);
      })
      .catch(err => console.error(err));
  }

  function drawCalendar(containerId, year, month, busyList) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    const table = document.createElement('table');
    const caption = document.createElement('caption');
    caption.innerText = monthNames[month-1] + ' ' + year;
    table.appendChild(caption);
    const header = table.insertRow();
    const days = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
    days.forEach(d => {
      const th = document.createElement('th');
      th.innerText = d;
      header.appendChild(th);
    });
    // Определяем смещение первого дня недели
    const firstDay = new Date(year, month-1, 1).getDay();
    const offset = (firstDay + 6) % 7; // Переносим Sunday(0) к концу
    let row = table.insertRow();
    for (let i = 0; i < offset; i++) {
      row.insertCell();
    }
    const totalDays = new Date(year, month, 0).getDate();
    for (let day = 1; day <= totalDays; day++) {
      if ((offset + day - 1) % 7 === 0 && day !== 1) {
        row = table.insertRow();
      }
      const cell = row.insertCell();
      const dateStr = year + '-' + String(month).padStart(2,'0') + '-' + String(day).padStart(2,'0');
      cell.innerText = day;
      cell.dataset.date = dateStr;
      if (busyList.includes(dateStr)) {
        cell.className = 'busy';
      } else {
        cell.className = 'free';
        cell.addEventListener('click', onDateClick);
      }
    }
    container.appendChild(table);
  }

  function onDateClick(e) {
    const date = e.target.dataset.date;
    if (!selectedStart) {
      selectedStart = date;
      e.target.classList.add('selected');
    } else if (!selectedEnd) {
      if (date <= selectedStart) {
        // Если выбран до или тот же день, начинаем заново
        clearSelected();
        selectedStart = date;
        e.target.classList.add('selected');
      } else {
        // Проверяем свободны ли все даты в промежутке
        let d = new Date(selectedStart);
        let ok = true;
        while (d < new Date(date)) {
          const dStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
          if (busyDates.includes(dStr)) {
            ok = false;
            break;
          }
          d.setDate(d.getDate() + 1);
        }
        if (!ok) {
          alert('Выбранный период частично занят');
          return;
        }
        selectedEnd = date;
        // Выделяем диапазон
        document.querySelectorAll('[data-date]').forEach(cell => {
          const dStr = cell.dataset.date;
          if (dStr >= selectedStart && dStr <= selectedEnd && !busyDates.includes(dStr)) {
            cell.classList.add('selected');
          }
        });
        // Показать детали бронирования
        showBookingDetails();
      }
    } else {
      // Если диапазон уже был выбран, начинаем новый выбор
      clearSelected();
      selectedStart = date;
      selectedEnd = null;
      e.target.classList.add('selected');
      document.getElementById('bookingDetails').style.display = 'none';
      document.getElementById('customerForm').style.display = 'none';
    }
  }

  function clearSelected() {
    document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
  }

  function showBookingDetails() {
    if (selectedStart && selectedEnd) {
      const start = new Date(selectedStart);
      const end = new Date(selectedEnd);
      const diff = (end - start) / (1000*60*60*24);
      const nights = diff;
      const cost = nights * selectedRoom.price;
      document.getElementById('dateRange').innerText = 'Период: ' + selectedStart + ' - ' + selectedEnd +
        ' (' + nights + ' ночей), всего: ' + cost + ' руб.';
      document.getElementById('bookingDetails').style.display = 'block';
    }
  }

  function showCustomerForm() {
    const guests = parseInt(document.getElementById('guestsInput').value, 10);
    if (!selectedStart || !selectedEnd) {
      alert('Выберите период.');
      return;
    }
    if (!guests || guests < 1) {
      alert('Введите количество гостей.');
      return;
    }
    if (guests > selectedRoom.capacity) {
      alert('Максимальная вместимость: ' + selectedRoom.capacity);
      return;
    }
    document.getElementById('bookingDetails').style.display = 'none';
    document.getElementById('customerForm').style.display = 'block';
  }

  function submitBooking() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const wishes = document.getElementById('wishes').value.trim();
    const guests = parseInt(document.getElementById('guestsInput').value, 10);
    if (!name || !phone || !email) {
      alert('Заполните все обязательные поля.');
      return;
    }
    // Проверка телефона по шаблону 8-(XXX)-XXX-XX-XX
    const phonePattern = /^8-\\([0-9]{3}\\)-[0-9]{3}-[0-9]{2}-[0-9]{2}$/;
    if (!phonePattern.test(phone)) {
      alert('Телефон в формате 8-(XXX)-XXX-XX-XX');
      return;
    }
    const bookingData = {
      action: 'book',
      room_id: selectedRoom.id,
      start: selectedStart,
      end: selectedEnd,
      guests: guests,
      name: name,
      phone: phone,
      email: email,
      wishes: wishes
    };
    fetch(GAS_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(bookingData)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('modalText').innerText = 'Бронирование успешно. Ваш ID: ' + data.bookingId;
        document.getElementById('modal').style.display = 'block';
      } else {
        alert('Ошибка: ' + data.error);
      }
    })
    .catch(err => alert('Ошибка отправки: ' + err));
  }
  </script>
</body>
</html>
