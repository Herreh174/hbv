<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Бронирование номеров</title>
  <!-- Подключаем Flatpickr из CDN для визуального календаря -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Простые стили для модального окна */
    #modalOverlay {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); 
    }
    #modalContent {
      position: relative;
      width: 300px; margin: 100px auto;
      padding: 20px; background: white; text-align: center;
      border-radius: 5px;
    }
    label { display: block; margin: 5px 0; }
    input, select, textarea { width: 100%; padding: 5px; margin-top: 3px; }
    #calendarContainer { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Модуль бронирования номеров</h1>
  <!-- Выбор номера -->
  <label>Номер:
    <select id="roomSelect">
      <option value="">-- Выберите номер --</option>
    </select>
  </label>
  <!-- Календарь для выбора дат (Flatpickr) -->
  <div id="calendarContainer">
    <input id="datePicker" type="text" placeholder="Выберите даты заезда и выезда" readonly>
  </div>
  <!-- Выбор количества гостей -->
  <label>Число гостей:
    <input id="guestsInput" type="number" min="1">
    <small> (максимум вместимость указанного номера)</small>
  </label>
  <!-- Форма данных клиента (скрыта до валидации) -->
  <form id="clientForm" style="display:none; margin-top:10px;">
    <label>ФИО:<input id="fullName" type="text" required></label>
    <label>Телефон:<input id="phone" type="text" placeholder="8-(000)-000-00-00"
                       pattern="8-\(\d{3}\)-\d{3}-\d{2}-\d{2}" required></label>
    <label>Email:<input id="email" type="email" required></label>
    <label>Пожелания:<textarea id="wishes" rows="3"></textarea></label>
    <button type="button" id="bookButton" disabled>Забронировать</button>
  </form>

  <!-- Модальное окно подтверждения -->
  <div id="modalOverlay">
    <div id="modalContent">
      <p>Ваш ID бронирования: <span id="bookingIdSpan"></span></p>
      <button onclick="document.getElementById('modalOverlay').style.display='none';">OK</button>
    </div>
  </div>

  <!-- Подключаем Flatpickr и основной скрипт -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6tJjuDtyC-Q3f8HpBn5CfGLFogw4ieiJ9B-0mrvLOsPAx8sVDS7rwfN-O8JfaXb2c/exec'; // Замените на URL вашего Apps Script

    let roomsMap = {}; // Словарь room_id -> {name, price, capacity}
    let selectedRoomId = null;

    // Загрузка списка номеров при инициализации
    fetch(SCRIPT_URL + '?action=getRooms')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('roomSelect');
        data.forEach(room => {
          roomsMap[room.room_id] = room;
          let opt = document.createElement('option');
          opt.value = room.room_id;
          opt.text = `${room.room_name} (цена ${room.price}₽, вместимость ${room.capacity})`;
          select.add(opt);
        });
      });

    // Обработчик выбора номера
    document.getElementById('roomSelect').onchange = function() {
      selectedRoomId = this.value;
      // Сброс календаря и формы
      document.getElementById('datePicker').value = '';
      document.getElementById('clientForm').style.display = 'none';
      document.getElementById('bookButton').disabled = true;
      if (!selectedRoomId) {
        return;
      }
      // Запрашиваем занятые даты для текущего и следующего месяца
      const today = new Date();
      let curMonth = today.getMonth()+1, curYear = today.getFullYear();
      let nextMonth = curMonth + 1, nextYear = curYear;
      if (nextMonth > 12) { nextMonth = 1; nextYear++; }
      Promise.all([
        fetch(`${SCRIPT_URL}?action=getCalendar&room_id=${selectedRoomId}&month=${curMonth}&year=${curYear}`),
        fetch(`${SCRIPT_URL}?action=getCalendar&room_id=${selectedRoomId}&month=${nextMonth}&year=${nextYear}`)
      ]).then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
          // Собираем массив дат, полученных из JSON {dates: [...]} или просто [...]
          let disabledDates = [];
          results.forEach(result => {
            if (Array.isArray(result)) {
              // если сервер вернул просто массив
              disabledDates = disabledDates.concat(result);
            } else if (result.dates) {
              disabledDates = disabledDates.concat(result.dates);
            }
          });
          // Инициализируем календарь Flatpickr
          flatpickr("#datePicker", {
            mode: "range",
            dateFormat: "Y-m-d",
            showMonths: 2,
            disable: disabledDates,
            minDate: "today",
            onClose: validateForm
          });
        });
    };

    // Проверка валидации после выбора дат или изменения числа гостей
    function validateForm() {
      const dateValue = document.getElementById('datePicker').value;
      const guests = parseInt(document.getElementById('guestsInput').value);
      const room = roomsMap[selectedRoomId];
      if (!dateValue || isNaN(guests) || !room || guests < 1 || guests > room.capacity) {
        document.getElementById('clientForm').style.display = 'none';
        return;
      }
      // Показать форму для ввода данных клиента
      document.getElementById('clientForm').style.display = 'block';
    }

    // При изменении количества гостей снова проверяем валидацию
    document.getElementById('guestsInput').oninput = validateForm;

    // Активация кнопки после ввода всех полей
    document.getElementById('clientForm').oninput = function() {
      const form = document.getElementById('clientForm');
      document.getElementById('bookButton').disabled = !form.checkValidity();
    };

    // Обработчик нажатия "Забронировать"
    document.getElementById('bookButton').onclick = function() {
      const dates = document.getElementById('datePicker').value.split(" to ");
      const payload = {
        name: document.getElementById('fullName').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        guests: parseInt(document.getElementById('guestsInput').value),
        checkIn: dates[0],
        checkOut: dates[1],
        room_id: selectedRoomId
      };
      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(response => {
        // Показываем модальное окно с ID бронирования
        document.getElementById('bookingIdSpan').innerText = response.bookingId;
        document.getElementById('modalOverlay').style.display = 'block';
        // Сброс формы
        document.getElementById('clientForm').reset();
        document.getElementById('clientForm').style.display = 'none';
        document.getElementById('bookButton').disabled = true;
      })
      .catch(err => alert('Ошибка при бронировании: ' + err));
    };
  </script>
</body>
</html>
