<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Бронирование</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { padding: 5px; width: 100%; max-width: 400px; }
    .hidden { display: none; }
    .btn { margin-top: 20px; padding: 10px 20px; }
    .disabled { background: #ccc; pointer-events: none; }
  </style>
</head>
<body>
  <h1>Бронирование номера</h1>

  <label for="room">Выберите номер:</label>
  <select id="room"></select>

  <label for="guests">Количество гостей:</label>
  <input type="number" id="guests" min="1">

  <label for="checkin">Дата заезда:</label>
  <input type="date" id="checkin">

  <label for="checkout">Дата выезда:</label>
  <input type="date" id="checkout">

  <button id="checkAvailability" class="btn disabled">Перейти к вводу данных</button>

  <div id="guestInfo" class="hidden">
    <label for="name">ФИО:</label>
    <input type="text" id="name">

    <label for="phone">Телефон:</label>
    <input type="tel" id="phone" placeholder="8-(___)-___-__-__">

    <label for="email">Email:</label>
    <input type="email" id="email">

    <label for="notes">Пожелания по размещению:</label>
    <textarea id="notes"></textarea>

    <button id="submitBooking" class="btn disabled">Забронировать</button>
  </div>

  <div id="successModal" class="hidden">
    <h2>Бронирование успешно!</h2>
    <p id="bookingId"></p>
  </div>

  <script>
    const roomSelect = document.getElementById('room');
    const guestsInput = document.getElementById('guests');
    const checkinInput = document.getElementById('checkin');
    const checkoutInput = document.getElementById('checkout');
    const checkAvailabilityBtn = document.getElementById('checkAvailability');
    const guestInfoDiv = document.getElementById('guestInfo');
    const submitBtn = document.getElementById('submitBooking');
    const successModal = document.getElementById('successModal');
    const bookingIdP = document.getElementById('bookingId');

    let roomsData = [];

    // Загрузка списка номеров
    function loadRooms() {
      fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_URL/exec?action=getRooms')
        .then(res => res.json())
        .then(data => {
          roomsData = data;
          data.forEach(room => {
            const opt = document.createElement('option');
            opt.value = room.room_id;
            opt.textContent = `${room.room_name} — ${room.price}₽/ночь — ${room.capacity} гостей`;
            roomSelect.appendChild(opt);
          });
        });
    }

    // Проверка доступности
    function checkAvailability() {
      const roomId = roomSelect.value;
      const guests = parseInt(guestsInput.value, 10);
      const checkin = checkinInput.value;
      const checkout = checkoutInput.value;

      if (!roomId || !guests || !checkin || !checkout || checkin >= checkout) return;

      const selectedRoom = roomsData.find(r => r.room_id === roomId);
      if (guests > selectedRoom.capacity) {
        alert('Количество гостей превышает допустимое!');
        return;
      }

      fetch(`https://script.google.com/macros/s/YOUR_DEPLOYED_URL/exec?action=checkAvailability&room_id=${roomId}&checkin=${checkin}&checkout=${checkout}`)
        .then(res => res.json())
        .then(data => {
          if (data.available) {
            checkAvailabilityBtn.classList.remove('disabled');
            guestInfoDiv.classList.remove('hidden');
          } else {
            alert('Выбранные даты недоступны');
          }
        });
    }

    // Отправка брони
    function submitBooking() {
      const payload = {
        action: 'submitBooking',
        room_id: roomSelect.value,
        guests: guestsInput.value,
        checkin: checkinInput.value,
        checkout: checkoutInput.value,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        notes: document.getElementById('notes').value,
      };

      fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_URL/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            bookingIdP.textContent = `Ваш ID брони: ${data.bookingId}`;
            successModal.classList.remove('hidden');
          } else {
            alert('Ошибка при бронировании');
          }
        });
    }

    document.addEventListener('DOMContentLoaded', loadRooms);
    checkAvailabilityBtn.addEventListener('click', checkAvailability);
    submitBtn.addEventListener('click', submitBooking);
  </script>
</body>
</html>
